2003-04-14  Dan Winship  <danw@ximian.com>

	* libsoup/soup-dns.c: New. Move most of the DNS code here from
	SoupAddress.

	* libsoup/soup-address.c: (soup_address_new,
	soup_address_get_name): Use soup-dns
	(soup_address_hash, soup_address_equal): Remove since soup-address
	doesn't hash addresses now.
	(...) Remove lots of other stuff that's in soup-dns now

	* libsoup/Makefile.am (libsoupinclude_HEADERS): add soup-dns.h
	(libsoup_2_0_la_SOURCES): and soup-dns.c

	* libsoup/soup-socket.c (done_connect): clear the connect_func
	before calling it so that if the socket gets finalized from the
	callback we don't crash.

2003-04-14  Dan Winship  <danw@ximian.com>

	* libsoup/soup-socket.c: Make SoupSocket a GObject. All fields are
	now private.
	(soup_socket_new): Now just returns a (unconnected) socket.
	(soup_socket_connect_by_addr, soup_socket_connect_by_name):
	Replace the old soup_socket_new and soup_socket_connect calls.
	Work on an already existing (but not connected) socket. Errors are
	now always returned async, never immediately.
	(soup_socket_connect_cancel): Takes an actual SoupSocket now
	rather than a "connect id"
	(soup_socket_ref, soup_socket_unref): No longer needed

	* configure.in: Update glib check to include gobject

	* libsoup/soup-private.h (SOUP_MAKE_TYPE): gobject helper, copied
	from E_MAKE_TYPE in gal.

	* libsoup/soup-server.c: Use g_object_ref/unref on sockets.
	* libsoup/soup-socks.c: Likewise

	* libsoup/soup-connection.c (connection_free): Use g_object_unref
	(soup_connection_from_socket): Ref the socket
	(SoupConnectData): Change the connect_tag to an actual socket.
	(soup_connection_new_cb): Unref the socket when cleaning up.
	(soup_connection_new_via_proxy): Update soup_socket_connect call
	to use soup_socket_new and soup_socket_connect_by_name.
	(soup_connection_cancel_connect): Update call to
	soup_socket_connect_cancel.

	* tests/get.c (main): Call g_type_init().
	* tests/simple-httpd.c (main): Likewise
	* tests/timeserver.c (main): Likewise

2003-04-11  Dan Winship  <danw@ximian.com>

	* libsoup/soup-misc.c (soup_set_proxy, soup_get_proxy): Remove.
	Proxies must be dealt with at the connection level, not globally.
	(soup_set_connection_limit, soup_get_connection_limit): Remove.
	Connection limits should be per host/per context, not global.
	(soup_set_security_policy, soup_get_security_policy): Remove. Not
	used.
	(soup_set_authorize_callback): Remove. Authorize callbacks need to
	be per context, not global

	* libsoup/soup-auth.h: Move SoupAuthType definition here from
	soup-misc.h

	* libsoup/soup-context.c (try_create_connection): Remove
	connection limit refs
	(prune_least_used_connection): Removed

	* libsoup/soup-connection.c: Remove last_used_id field since
	soup-context no longer prunes connections

	* libsoup/soup-message.h: Remove unused NO_PIPELINE and NO_COOKIES
	flags

	* libsoup/soup-message.c (authorize_handler): Remove global
	authorize handler stuff.

	* libsoup/soup-queue.c (soup_debug_print_headers): Removed

	* libsoup/soup-openssl.c: 
	* libsoup/soup-ssl-proxy.c: 
	* libsoup/soup-ssl.c:
	* libsoup/soup-nss.c: Remove security policy stuff

	* tests/get.c (main): Remove connection limit code

2003-04-11  Dan Winship  <danw@ximian.com>

	* libsoup/soup-ntlm.[ch]: Remove. NTLM totally violates the HTTP
	auth spec, and shoehorning it into soup just adds a lot of
	complexity. In the new-and-improved API, we should be able to
	handle NTLM auth externally to libsoup.

	* libsoup/Makefile.am (libsoupinclude_HEADERS,
	libsoup_2_0_la_SOURCES): remove soup-ntlm

	* libsoup/soup-auth.c: Remove NTLM code

	* libsoup/soup-server-auth.c: Remove NTLM code which was never
	completed and never could have been anyway.

	* libsoup/soup-private.h: Remove "auth" field from SoupConnection.

	* libsoup/soup-message.c (soup_message_requeue): Remove all the
	complicated stuff here that was only to deal with NTLM
	(authorize_handler): Remove NTLM handling.

	* libsoup/soup-queue.c (soup_encode_http_auth): Remove NTLM code

2002-11-22  Dan Winship  <danw@ximian.com>

	* libsoup/soup-types.h: New, typedefs for basic soup structs, to
	prevent #include loops.

	* libsoup/Makefile.am (libsoupinclude_HEADERS): add soup-types.h

	* update #includes appropriately

2002-11-22  Dan Winship  <danw@ximian.com>

	* libsoup/soup-uri.c: Update this to match RFC 2396. In
	particular: Don't parse "parameters" separately from "path", never
	copy a "fragment" from the base URI, and consider the relative URI
	"?x" to have a path of "" rather than no path. Also fix a bug that
	could result in the port not getting set to the right default when
	resolving certain relative URIs.

	* tests/uri-parsing.c: Update the tests and answers to match the
	examples from RFC 2396.

2002-11-19  Dan Winship  <danw@ximian.com>

	* libsoup/soup-message.c: Move context into SoupMessagePrivate.
	Update for that.
	(soup_message_get_uri): New, to get the URI from a SoupMessage
	(which is all most people ever wanted the context for)

	* libsoup/soup-auth.c (compute_response, digest_auth_func): Use
	soup_message_get_uri.

	* libsoup/soup-queue.c: Likewise

	* libsoup/soup-server.c (call_handler, read_done_cb): Likewise.

	* libsoup/soup-server-auth.c (parse_digest): Likewise.

	* tests/get.c (got_url): Likewise.

	* tests/simple-httpd.c (server_callback): Likewise.

2002-11-18  Dan Winship  <danw@ximian.com>

	* libsoup/soup-server.c (struct _SoupServer): Moved here from
	soup-private.h
	(SoupServerMessage): Made private and changed around a bit. This
	is now a wrapper around SoupMessage.
	(message_new): Create a new empty SoupServerMessage and then call
	soup_message_construct on it.
	(various): Update to deal with casting SoupMessage to
	SoupServerMessage to get the server, socket, etc fields rather
	than using msg->priv->server, server_sock, server_msg.
	(soup_server_message_new, soup_server_message_get_source): Gone
	(soup_server_message_start, soup_server_message_add_data,
	soup_server_message_finish): Now take a SoupMessage.

	* libsoup/soup-private.h (struct _SoupServer): Gone. Now private
	to soup-server.c
	(struct _SoupMessagePrivate): Remove the server, server_sock, and
	server_msg fields.

	* libsoup/soup-message.c (soup_message_construct): New.
	(soup_message_new): Use it.

2002-11-18  Dan Winship  <danw@ximian.com>

	* libsoup/soup-socket.c (struct _SoupSocket): Moved here from
	soup-private.h.
	(soup_socket_connect, soup_socket_server_new, soup_socket_new):
	Take an "ssl" argument saying whether or not to use SSL.
	(soup_socket_new_cb): Call soup_socket_start_ssl if needed.
	(server_accept_internal): Likewise.
	(soup_socket_get_local_address, soup_socket_get_local_port): Get
	the local address/port, regardless of socket type.
	(soup_socket_get_remote_address, soup_socket_get_remote_port): Get
	remote address/port, regardless of socket type.
	(soup_socket_start_ssl): Call soup_ssl_get_iochannel and wrap our
	iochannel with the result.

	* libsoup/soup-connection.c (soup_connection_from_socket): Don't
	need to worry about SSL here.
	(soup_connection_new_cb): Use soup_socket_start_ssl after CONNECT.
	(soup_connection_new_via_proxy): Pass the "ssl" arg to
	soup_socket_connect.
	(soup_connection_get_iochannel): Just call
	soup_socket_get_iochannel. We don't have our own iochannel any
	more.

	* libsoup/soup-server.c (soup_server_new): Pass "ssl" arg to
	soup_socket_server_new.
	(read_headers_cb): Use soup_socket_get_local_address and
	soup_address_get_canonical_name rather than using socket functions
	(conn_accept): Don't need to handle SSL here any more.

	* libsoup/soup-ssl.c (soup_ssl_get_iochannel): Make this take a
	SoupSSLType argument so it can be used for either client or
	server.

	* libsoup/soup-private.h (struct _SoupSocket): Gone. Private to
	soup-socket.c now.
	(struct _SoupConnection): Remove "channel" member.

	* tests/timeserver.c: Fix so that it uses IPv4 again if you don't
	pass "-6", and add a "-s" arg to do SSL.

2002-11-18  Dan Winship  <danw@ximian.com>

	* libsoup/soup-connection.c: New, split SoupConnection stuff out
	of soup-context.c. (A SoupConnection wraps a SoupSocket and also
	handles proxies and keepalive-ness.)

	* libsoup/soup-private.h (struct _SoupConnection): Remove the
	server and context fields, which are no longer relevant to a
	SoupConnection, and the port field, which can be extracted from
	the socket if needed.

	* libsoup/soup-context.c: Remove SoupConnection code and update
	accordingly. (SoupContext still handles try_existing_connections,
	soup_connection_limit, and timeouts to wait for a connection to
	become available.)

	* libsoup/soup-queue.c: Remove proxy-handling code. SoupConnection
	does this itself now.

	* libsoup/soup-socks.c: Make this work at the SoupSocket level
	rather than the SoupConnection level.

	* libsoup/Makefile.am: add soup-connection.[ch]

2002-11-18  Dan Winship  <danw@ximian.com>

	* libsoup/soup-error.c: add SOUP_ERROR_CANT_RESOLVE and
	SOUP_ERROR_CANT_RESOLVE_PROXY. Consistentify the capitalization of
	the transport error phrases.

	* libsoup/soup-address.c: Replace SoupAddressStatus with
	SoupKnownErrorCode (SOUP_ERROR_OK and SOUP_ERROR_CANT_RESOLVE)

	* libsoup/soup-context.c: Replace SoupConnectErrorCode with
	SoupKnownErrorCode (SOUP_ERROR_OK, SOUP_ERROR_CANT_RESOLVE, and
	SOUP_ERROR_CANT_CONNECT)

	* libsoup/soup-socket.c: Replace SoupSocketConnectStatus and
	SoupSocketNewStatus with SoupKnownErrorCode (SOUP_ERROR_OK,
	SOUP_ERROR_CANT_RESOLVE and SOUP_ERROR_CANT_CONNECT).

	* libsoup/*.c: Update for status code changes.
	
2002-11-18  Dan Winship  <danw@ximian.com>

	* libsoup/soup-error.c: Fix spelling of
	SOUP_ERROR_MOVED_PERMANENTLY and its description.

	* tests/simple-httpd.c: Very simple httpd using soup-server, based
	somewhat on the old soup-httpd.

	* tests/Makefile.am (noinst_PROGRAMS): build simple-httpd

2002-11-17  Dan Winship  <danw@ximian.com>

	* libsoup/soup-uri.c: Update with newer code taken from Camel.
	Handles relative URIs, URI parameters and fragments, and does
	%-encoding/decoding in the appropriate places.
	(soup_uri_to_string): Change the second arg to be "just_path",
	which specifies the caller wants just the path (and params and
	query) parts.
	(soup_uri_encode, soup_uri_decode): New.

	* libsoup/soup-auth.c (compute_response): Use soup_uri_to_string.
	(digest_auth_func): Likewise.
	* libsoup/soup-queue.c (soup_get_request_header): Likewise
	* libsoup/soup-server-auth.c (parse_digest): Likewise

	* libsoup/soup-message.c (soup_message_get_request_header, etc):
	Remove long-deprecated API.

	* libsoup/soup-context.c (soup_context_uri_hash,
	soup_context_uri_equal): Don't include query in the comparison.
	Two URIs that are identical except for query can still use the
	same auths.

	* tests/uri-parsing.c: SoupUri test program (also stolen from
	Camel)

	* tests/timeserver.c: Add "-6" to listen on the IPv6 local address
	instead of IPv4. (Tested on OS X.)

	* tests/get.c: Add "-r" for recursive get. (Tests the connection
	re-use and timeout code.)

	* tests/Makefile.am: re-enable timeserver, add uri-parsing.

2002-11-16  Dan Winship  <danw@ximian.com>

	* libsoup/soup-message.c (soup_message_queue): Set the callback
	and user_data before calling soup_queue_message.
	(requeue_read_error, requeue_read_finished, soup_message_requeue):
	Don't need to re-pass callback and user-data to
	soup_queue_message.

	* libsoup/soup-queue.c (soup_queue_message): Just take the
	message, not the callback and user_data (since no code ever
	changes those after they're first passed to soup_message_queue).

	* libsoup/soup-private.h (SoupHost): Add a "port" field.
	(SoupConnections to a given host are already being separated by
	port, and SoupAuths should be as well according to RFC2617).
	(SoupMessagePrivate): Remove unused "timeout_tag" field.
	
	* libsoup/soup-context.c (soup_context_host_hash,
	soup_context_host_equal): SoupHost hash functions.
	(soup_context_from_uri): Make soup_hosts a hash table on SoupHost
	so we can hash on port as well.
	(soup_context_unref): Update for that.
	(try_existing_connections): Don't need to filter on port now since
	the SoupHost will only have connections to a single port.

	* libsoup/soup-address.c (soup_address_hash): Don't use s6_addr32
	since it's apparently non-portable. Use s6_addr instead.
	(soup_gethostbyaddr): fix a sometimes-uninitialized variable.

	* libsoup/soup-socket.c (soup_socket_connect): remove unused
	variable.

	* libsoup/soup-openssl.c (soup_openssl_read): Use gsize.
	* libsoup/soup-server.c (cgi_read): Likewise
	* libsoup/soup-socks.c (soup_socks_write, soup_socks_read):
	Likewise.
	* libsoup/soup-ssl-proxy.c (soup_ssl_proxy_readwrite): Likewise.
	* libsoup/soup-transfer.c (soup_transfer_read_cb,
	soup_transfer_write_cb): Likewise.

2002-11-15  Dan Winship  <danw@ximian.com>

	* libsoup/*: Change old Helix Code refs to Ximian (and update
	copyright dates).

2002-11-15  Frank Belew  <frb@ximian.com>

	* tests/Makefile.am: uncomment lines to make timeserver build 
	correctly
	
2002-11-14  Joe Shaw  <joe@ximian.com>

	* libsoup/soup-address.c (soup_address_new): When we get an
	address from the hash, call our address lookup callback or else
	the connection will hang.

2002-11-13  Dan Winship  <danw@ximian.com>

	* tests/timeserver.c: Oops, commit this.

	* tests/Makefile.am (noinst_PROGRAMS): reenable timeserver.

2002-11-13  Joe Shaw  <joe@ximian.com>

	* libsoup/Makefile.am: Replace the BINDIR define with LIBEXECDIR.
	(install-exec-hook): Install libsoup-ssl-proxy into libexecdir
	instead of bindir.

	* libsoup/soup-openssl.c (soup_openssl_close): Call SSL_shutdown()
	to properly shut down the SSL connection before closing the
	socket.

	* libsoup/soup-ssl-proxy.c (soup_ssl_proxy_readwrite): Close the
	iochannels before quitting the main loop.

	* tests/Makefile.am: disable building timeserver, the source file
	wasn't added.

2002-11-12  Dan Winship  <danw@ximian.com>

	* configure.in: Check for IPv6 support in networking headers.

	* libsoup/soup-address.c: Make the internal structure of
	SoupAddress entirely private, and make SoupAddress be more like a
	hostent and less like a sockaddr. (Ie, make it not have a port
	associated with it.) Document undocumented functions. Add
	completely-untested support for IPv6.
	(soup_address_new_from_sockaddr): New, to parse a sockaddr into a
	SoupAddress and a port.
	(soup_address_ipv4_any, soup_address_ipv6_any): Return static
	addresses corresponding to the IPv6 and IPv6 "any" addresses.
	(soup_address_get_canonical_name): Use inet_ntop/inet_ntoa.
	(soup_address_make_sockaddr): Now constructs a new sockaddr, which
	may be a sockaddr_in or sockaddr_in6.
	(soup_address_gethostname, soup_address_gethostaddr): Remove
	these. They aren't reliable, especially on multihomed hosts.
	(soup_gethostbyname, soup_gethostbyaddr): support IPv6
	(soup_address_new): Keep pending lookups in a separate hash table
	from completed lookups. Fix a bug when canceling a lookup when
	there was more one outstanding request for it.
	(soup_address_lookup_in_cache): Removed.

	* libsoup/soup-socket.c: Add a port field to SoupSocket (since
	it's not in SoupAddress any more).
	(soup_socket_connect): Simplify this. Don't use
	soup_address_lookup_in_cache, just call soup_address_new, since we
	already know the code can deal with the callback being invoked
	immediately.
	(soup_socket_new_sync, soup_socket_new): Take a port argument.
	(soup_socket_server_new): Take a SoupAddress to use as the local
	address to bind to. This lets the caller choose between the IPv4
	and IPv6 "any" addresses, and also lets you bind to a single
	interface of a multi-homed machine.
	(soup_socket_server_accept, soup_socket_server_try_accept): Merge
	the common code.

	* libsoup/soup-server.c (soup_server_new): Pass
	soup_address_ipv4_any() to soup_socket_server_new().

	* libsoup/soup-socks.c (soup_connect_socks_proxy,
	soup_socks_write): Fix up for the API changes, but it won't work
	with IPv6 yet.

	* tests/timeserver.c: Another really simple test, for the server
	socket code.

	* tests/Makefile.am: build timeserver

2002-11-11  Dan Winship  <danw@ximian.com>

	* libsoup/soup-address.c: Move the SoupAddress code from
	soup-socket.c and soup-socket-unix.c to here.

	* libsoup/soup-socket.c: Move the remaining code from
	soup-socket-unix.c here.

	* libsoup/soup-socket-unix.c: Gone

	* tests/get.c: really really trivial test program

	* configure.in (AC_OUTPUT):
	* Makefile.am (SUBDIRS): add tests/

2002-11-05  Dan Winship  <danw@ximian.com>

	* Split libsoup out of soup. ChangeLog.old contains the original
	soup ChangeLog.

	* Makefile.am, etc: Fix things up to work with the new directory
	layout. Disable docs until we fix them.

	* autogen.sh: Use gnome-autogen.sh

	* configure.in: Require autoconf 2.53. Remove stuff that was only
	needed for httpd or wsdl code. Remove glib1 support. Bump version
	to 2.0.

	* libsoup/Makefile.am: Rename library to libsoup-2.0, put includes
	in ${includedir}/soup-2.0
	
	* libsoup/*: Merge soup-0-7 back onto the trunk. Remove
	SOAP-specific stuff, Windows support, and other things that
	weren't being maintained.

	* soup-config.in, soupConf.sh: Kill these. We only support
	pkg-config now.
